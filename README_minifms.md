# MiniFMS Pro - 高级文件管理系统

## 🌟 项目概述

MiniFMS Pro 是一个完整的虚拟文件管理系统，学习了 MiniOS 的设计思路，实现了从用户管理到文件操作的完整功能集。系统支持多进程共享虚拟磁盘，具备完整的安全性和并发控制。

## 🎯 评分要求覆盖 (满分100分)

### 1. 用户管理模块 (6分) ✅

- ✅ **用户注册功能**: 支持新用户注册，自动用户名冲突检测
- ✅ **密码存储验证**: 安全的密码存储和验证机制
- ✅ **会话保持**: 用户登录后会话持续到主动退出
- ✅ **登录限制**: 3次密码错误后自动锁定账户
- ✅ **用户数据隔离**: 每个用户只能访问自己的文件和目录

### 2. 16个命令实现 (48分) ✅

#### 文件类命令 (36分)

- ✅ **create** - 创建文件
- ✅ **delete** - 删除文件
- ✅ **open** - 打开文件 (支持 r/w/rw 模式)
- ✅ **close** - 关闭文件
- ✅ **read** - 读取文件内容
- ✅ **write** - 写入文件内容
- ✅ **move** - 移动/重命名文件
- ✅ **copy** - 复制文件
- ✅ **flock** - 文件加锁/解锁
- ✅ **head** - 显示文件前N行
- ✅ **tail** - 显示文件后N行
- ✅ **lseek** - 文件指针移动

#### 目录类命令 (12分)

- ✅ **cd** - 切换目录 (支持 .. 返回上级)
- ✅ **dir** - 显示当前目录内容
- ✅ **mkdir** - 创建目录
- ✅ **rmdir** - 删除空目录

### 3. 导入导出功能 (20分) ✅

- ✅ **import** - 从本地磁盘导入文件到虚拟系统
- ✅ **export** - 从虚拟系统导出文件到本地磁盘
- ✅ 支持二进制文件传输
- ✅ 完整的错误处理和文件大小检查

### 4. 多线程支持 (16分) ✅

- ✅ **双线程架构**: 用户交互线程 + 磁盘维护线程
- ✅ **多进程支持**: 支持同时运行多个程序实例
- ✅ **共享虚拟磁盘**: 所有进程共享同一个虚拟磁盘状态
- ✅ **线程同步**: 基于 mutex + condition_variable 的同步机制
- ✅ **并发安全**: 完整的锁机制保证数据一致性

### 5. 完整目录树 (10分) ✅

- ✅ **树形显示**: 完整的目录树结构显示
- ✅ **文件信息**: 显示文件大小、修改时间等元数据
- ✅ **递归遍历**: 完整遍历所有子目录和文件
- ✅ **美观格式**: 使用 Unicode 图标美化显示

## 🏗️ 系统架构

### 核心设计思路 (学习 MiniOS)

```
用户进程1     用户进程2     用户进程3
    |            |            |
    ▼            ▼            ▼
┌─────────────────────────────────────┐
│          用户交互线程                 │
│     (命令解析、界面显示)               │
└─────────────┬───────────────────────┘
              │ 命令队列
              ▼
┌─────────────────────────────────────┐
│         磁盘维护线程                  │
│     (文件系统操作、同步)              │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│          共享虚拟磁盘                 │
│    (FCB表、用户数据、文件内容)        │
└─────────────────────────────────────┘
```

### 数据结构设计

#### 用户管理 (User)

```cpp
struct User {
    int isused;              // 使用标志
    char username[32];       // 用户名
    char password[32];       // 密码
    bool locked;             // 锁定状态
    int loginFailCount;      // 失败次数
    int rootDirId;          // 根目录ID
    int userId;             // 用户ID
    time_t createTime;      // 创建时间
};
```

#### 文件控制块 (FCB)

```cpp
struct FCB {
    int isused;              // 使用标志
    char name[64];           // 文件名
    int type;                // 类型(0=文件,1=目录)
    int owner;               // 所有者ID
    size_t size;             // 文件大小
    time_t createTime;       // 创建时间
    time_t modifyTime;       // 修改时间
    time_t accessTime;       // 访问时间
    bool locked;             // 锁定状态
    int lockOwner;           // 锁定者
    int parentDir;           // 父目录ID
};
```

#### 打开文件描述符 (OpenFile)

```cpp
struct OpenFile {
    int fcbId;               // FCB ID
    int userId;              // 用户ID
    size_t position;         // 读写位置
    int mode;                // 打开模式
    bool isOpen;             // 打开状态
};
```

## 🚀 编译和运行

### 编译方法

```bash
# 使用编译脚本
chmod +x build_minifms.sh
./build_minifms.sh

# 或手动编译
# Windows:
g++ -std=c++17 -O2 -Wall -Wextra -o minifms.exe minifms.cpp

# Linux:
g++ -std=c++17 -O2 -Wall -Wextra -pthread -lrt -o minifms minifms.cpp
```

### 运行程序

```bash
# Windows
./minifms.exe

# Linux  
./minifms
```

## 📖 使用指南

### 系统启动

```
╔════════════════════════════════╗
║         MiniFMS 2.0 Pro        ║
║    多进程共享文件管理系统        ║
╠════════════════════════════════╣
║  1. 🆕 注册新用户               ║
║  2. 🔑 用户登录                 ║
║  0. 🚪 退出系统                 ║
╚════════════════════════════════╝
```

### 用户管理

1. **注册用户**: 选择选项1，输入用户名和密码
2. **登录系统**: 选择选项2，输入用户名和密码
3. **自动隔离**: 每个用户只能看到自己的文件

### 文件操作示例

```bash
# 创建文件
create hello.txt

# 打开文件进行写入
open hello.txt w

# 写入内容 (文件描述符为0)
write 0
Hello, MiniFMS Pro!
This is a test file.
.

# 关闭文件
close 0

# 读取文件
open hello.txt r
read 0

# 显示文件前3行
head hello.txt 3

# 复制文件
copy hello.txt backup.txt

# 文件加锁
flock hello.txt
```

### 目录操作示例

```bash
（）# 创建目录
mkdir documents

# 进入目录
cd documents

# 返回上级目录
cd ..

# 显示目录内容
dir

# 显示目录树
tree

# 删除空目录
rmdir documents

# 删除非空目录
rmdir documents -f
```

### 导入导出示例

```bash
# 从本地导入文件
import C:\data\test.txt myfile.txt

# 导出到本地
export myfile.txt C:\backup\myfile.txt
```

## 🔧 技术特性

### 多进程共享机制

- **Windows**: 使用 `CreateFileMapping` + `MapViewOfFile`
- **Linux**: 使用 `shm_open` + `mmap`
- **同步控制**: 基于文件锁和原子操作
- **版本管理**: 修改计数器实现状态同步

### 线程同步 (学习 MiniOS)

```cpp
// 命令提交 (用户线程)
{
    lock_guard<mutex> lock(queueMutex);
    commandQueue.push(CommandRequest(&session, cmdline));
}
queueCv.notify_one();

// 命令处理 (内核线程)
{
    unique_lock<mutex> lock(queueMutex);
    queueCv.wait(lock, [this]{ return !commandQueue.empty(); });
}
```

### 安全性保障

- **用户隔离**: 每个用户只能访问自己的文件
- **文件锁定**: 支持文件级别的排他锁
- **权限检查**: 完整的文件操作权限验证
- **错误处理**: 全面的异常处理和错误提示

## 🎨 界面特色

### 彩色终端界面

- 🟢 用户名显示: 绿色高亮
- 🔵 路径显示: 蓝色高亮
- ✅ 成功信息: 绿色勾号
- ❌ 错误信息: 红色叉号
- 📁 目录图标: Unicode 文件夹
- 📄 文件图标: Unicode 文档

### 智能提示系统

- 完整的命令帮助: `help`
- 参数格式提示: 自动显示正确用法
- 错误诊断: 详细的错误原因说明
- 操作确认: 重要操作的成功/失败反馈

## 🔍 命令参考

### 基础命令

- `help` - 显示帮助信息
- `exit` - 退出系统

### 目录操作

- `cd [目录名]` - 切换目录
- `cd ..` - 返回上级目录
- `dir` - 显示当前目录
- `mkdir [目录名]` - 创建目录
- `rmdir [目录名]` - 删除空目录
- `tree` - 显示目录树

### 文件操作

- `create [文件名]` - 创建文件
- `delete [文件名]` - 删除文件
- `open [文件名] [模式]` - 打开文件 (r/w/rw)
- `close [文件描述符]` - 关闭文件
- `read [文件描述符]` - 读取文件
- `write [文件描述符]` - 写入文件
- `lseek [fd] [偏移]` - 移动文件指针
- `copy [源] [目标]` - 复制文件
- `move [源] [目标]` - 移动/重命名文件
- `flock [文件名]` - 文件加锁/解锁
- `head [文件名] [行数]` - 显示文件开头
- `tail [文件名] [行数]` - 显示文件结尾

### 导入导出

- `import [本地路径] [虚拟路径]` - 导入文件
- `export [虚拟路径] [本地路径]` - 导出文件

## 🧪 测试建议

### 多进程测试

1. 启动多个程序实例
2. 在不同进程中创建/修改文件
3. 验证文件在所有进程中可见
4. 测试文件锁定机制

### 功能完整性测试

1. 测试所有16个命令
2. 验证用户隔离功能
3. 测试导入导出功能
4. 验证目录树显示

### 并发安全测试

1. 同时进行文件操作
2. 测试锁定机制
3. 验证数据一致性

## 🏆 项目亮点

1. **完整实现**: 100% 覆盖所有评分要求
2. **架构优秀**: 学习 MiniOS 的经典设计
3. **安全可靠**: 完整的权限控制和错误处理
4. **用户友好**: 美观的界面和详细的提示
5. **高性能**: 高效的多线程和共享内存机制
6. **跨平台**: 同时支持 Windows 和 Linux

## 📚 学习价值

这个项目深度学习了 MiniOS 的设计思路，包括：

- **双线程架构**: 用户交互线程 + 内核处理线程
- **消息队列机制**: 基于队列的命令传递
- **同步原语**: mutex + condition_variable 的经典组合
- **共享内存**: 进程间通信的高效实现
- **文件系统设计**: FCB、用户管理、权限控制

通过这个项目，可以深入理解操作系统的核心概念和实现技术。

---

**MiniFMS Pro** - 让文件管理更简单，让学习更深入！ 🚀
